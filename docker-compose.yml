version: '3.8'

services:
    app:
        container_name: newsparser
        restart: unless-stopped
        build:
            context: .
            dockerfile: Dockerfile.app
        environment:
            - PYTHONUNBUFFERED=1
            - MONGO_DB_URI=172.21.0.3:27017
        networks:
            - newsparser_default
        command: ["python", "main.py"]

    web:
        container_name: web
        restart: unless-stopped
        build:
            context: .
            dockerfile: Dockerfile.web
        environment:
            - PYTHONUNBUFFERED=1
            - FLASK_APP=web.py
            - FLASK_DEBUG=0
            - FLASK_ENV=production
            - MONGO_DB_URI=172.21.0.3:27017
        ports:
            - "5000:5000"
        networks:
            - newsparser_default
        healthcheck:
            test: curl --fail http://0.0.0.0:5000 || exit 1
        # command: ["flask", "run", "--host", "0.0.0.0", "--port", "5000"]
        # command: ["gunicorn"  , "-b", "0.0.0.0:5000", "web:app"]
        command: ["gunicorn","-k","eventlet","-w","1","-b","0.0.0.0:5000", "web:app"]

networks:
    newsparser_default:
        external: true